<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CMYK Inventory (Shared)</title>
<style>
  body{font-family:Arial;background:#f5f6fa;padding:20px}
  .card{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
  input,select,button{padding:10px;margin:6px 0;width:100%;border-radius:10px;border:1px solid #ccc}
  button{background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#fff;color:#111}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>*{flex:1;min-width:200px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px solid #eee;padding:10px;text-align:left}
  .history{border:1px solid #eee;background:#fafafa;border-radius:10px;padding:10px;max-height:260px;overflow:auto}
  .err{color:#c62828}
  .ok{color:#2e7d32}
  .tag{display:inline-block;background:#111;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px}
</style>
</head>
<body>

<div id="login" class="card">
  <h2>ðŸ”’ PIN Login</h2>
  <input id="pin" placeholder="Enter PIN (e.g. JCOHR4321)" />
  <button id="loginBtn">Login</button>
  <div class="err" id="loginErr"></div>
  <div style="font-size:12px;color:#666;margin-top:8px;">
    JCO HR: JCOHR4321<br/>
    JCO IT: JCOIT0625
  </div>
</div>

<div id="app" class="card" style="display:none;">
  <div class="row">
    <div><span class="tag" id="who"></span></div>
    <button class="secondary" id="refreshBtn">Refresh</button>
    <button class="secondary" id="logoutBtn">Logout</button>
  </div>

  <h2>CMYK Pigment Inventory (Shared)</h2>

  <table class="table">
    <thead><tr><th>Color</th><th>Stock</th></tr></thead>
    <tbody id="stockRows"></tbody>
  </table>

  <h3>Update Stock</h3>
  <div class="row">
    <select id="color">
      <option value="C">Cyan (C)</option>
      <option value="M">Magenta (M)</option>
      <option value="Y">Yellow (Y)</option>
      <option value="K">Black (K)</option>
    </select>
    <select id="action">
      <option value="add">Add</option>
      <option value="reduce">Reduce</option>
    </select>
    <input id="amount" placeholder="Amount" inputmode="numeric" />
  </div>
  <button id="applyBtn">Apply</button>

  <div class="err" id="err"></div>
  <div class="ok" id="ok"></div>

  <h3>History</h3>
  <div class="history" id="history"></div>
</div>

<script>
  let currentPin = "";
  let state = null;

  const $ = (id) => document.getElementById(id);

  function show(id, on){ $(id).style.display = on ? "block" : "none"; }
  function setText(id, t){ $(id).textContent = t || ""; }

  async function loadState(){
    const r = await fetch("/api/state");
    if(!r.ok) throw new Error("Failed to load state");
    state = await r.json();
  }

  function render(){
    const rows = ["C","M","Y","K"].map(c => `<tr><td>${c}</td><td>${state.stock[c] ?? 0}</td></tr>`).join("");
    $("stockRows").innerHTML = rows;

    const hist = (state.history || []).map(h =>
      `<div style="padding:6px 0;border-bottom:1px dashed #ddd;">
        <div><b>${h.user}</b> â€¢ ${h.date}</div>
        <div style="font-size:12px;color:#555;">
          ${h.color} ${h.action} ${h.amount} (${h.before} â†’ ${h.after})
        </div>
      </div>`
    ).join("");
    $("history").innerHTML = hist || `<div style="color:#666;font-size:12px;">No history yet.</div>`;
  }

  $("loginBtn").onclick = async () => {
    setText("loginErr","");
    currentPin = $("pin").value.trim();
    if(!currentPin) return setText("loginErr","Enter PIN.");

    try{
      await loadState();
      const name = state.users?.[currentPin];
      if(!name) return setText("loginErr","Invalid PIN.");

      $("who").textContent = name;

      show("login", false);
      show("app", true);
      render();
    }catch(e){
      setText("loginErr", e.message);
    }
  };

  $("logoutBtn").onclick = () => {
    currentPin = "";
    $("pin").value = "";
    show("app", false);
    show("login", true);
  };

  $("refreshBtn").onclick = async () => {
    setText("err",""); setText("ok","");
    try{ await loadState(); render(); setText("ok","Refreshed."); }
    catch(e){ setText("err", e.message); }
  };

  $("applyBtn").onclick = async () => {
    setText("err",""); setText("ok","");
    const color = $("color").value;
    const action = $("action").value;
    const amount = Number(($("amount").value || "").trim());
    if(!Number.isFinite(amount) || amount <= 0) return setText("err","Enter a valid amount.");

    try{
      const r = await fetch("/api/update", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ pin: currentPin, color, action, amount })
      });
      const data = await r.json();
      if(!r.ok) return setText("err", data.error || "Update failed");

      state = data;
      $("amount").value = "";
      render();
      setText("ok","Saved.");
    }catch(e){
      setText("err", e.message);
    }
  };
</script>

</body>
</html>
